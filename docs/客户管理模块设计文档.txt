================================================================================
                    OA 系统 - 客户管理模块 详细设计文档
================================================================================
版本：1.0
日期：2025-02-26
说明：本文档基于现有 OAOS 代码分析整理，供其他系统参考实现或迁移使用。
================================================================================


一、概述
--------------------------------------------------------------------------------
1.1 模块定位
    客户管理是 OA 系统的核心业务模块之一，负责企业客户档案、联系人、拜访跟进、
    客户公海、转交分享与审核等全生命周期管理，并与订单、项目、售后等模块紧密联动。

1.2 技术栈（当前实现）
    - 后端：C# / ASP.NET WebForms
    - 数据访问：MojoCube.Office 封装，直连 SQL Server
    - 前端：jQuery、Fancybox 弹窗、AspNetPager 分页、Bootstrap 风格 UI
    - 权限：基于 Session 与角色按钮（HasBtnRoleBool）控制

1.3 目录与代码分布
    - 表现层：OAOS/Customer/*.aspx、*.aspx.cs
    - 实体/业务：MojoCube.Office/Customer/（List.cs、CustomerIndustry.cs、CustomerSelect.cs）
    - 联系人：MojoCube.Office/Address/（CustomerLink、List 等）
    - 审核/通知：Customer_Audit_New、CustomerNoticeSend 等


二、功能模块详细说明
--------------------------------------------------------------------------------

2.1 客户档案（核心）

2.1.1 客户列表（List.aspx）
    - 功能：主入口列表，分页展示当前用户可见客户。
    - 列表列（可配置显示/隐藏）：
        客户来源、客户名称、所属行业、所在区域、客户覆盖区域、公司注册地址、
        微信添加情况、负责人、联系人、联系方式、回访记录、拜访记录、项目记录、
        最近修改时间等；客户名称支持“大客户”星标、“合并客户”绿点、“成单数”角标。
    - 筛选与搜索：
        - 高级搜索（弹窗）：客户来源、客户名称、省/市/县、覆盖区域、地址、
          状态、所属行业、负责人、创建人、联系人、联系电话、创建时间、是否大客户。
        - 快捷筛选：到期客户（合作到期）、关键词。
    - 操作按钮（受权限控制）：
        新增、转交、分享、全部转交、高级搜索、修改记录、合作记录、到期客户、
        客户模板（导出 Excel 模板）、客户导入、联系人模板、联系人导入、客户合并、
        自定义数据展示。
    - 行操作：查看/编辑、隐藏、关联客户、删除（需权限）等。
    - 数据源：View_Customer_List，结合 GridViewDisplay 表做列级权限（MenuUrl='Customer_List'）。

2.1.2 客户新增/编辑（Edit.aspx）
    - 功能：新建或编辑客户主数据，并集成联系人、受托方关联、拜访入口等。
    - 必填/主要字段：
        - 组织：选择部门、业务经理（fk_User/fk_Department）。
        - 基础：客户来源（CustomerSource）、状态（StatusID）、客户名称（FullName）。
        - 分类与区域：所属行业（多选，Customer_Industry）、公司性质、省/市/县、
          客户覆盖区域、公司注册地址。
        - 跟进：微信添加情况、主联系人、联系方式、备注等。
        - 标识：是否大客户、隐藏、合并标识（CombineFlag）等。
    - 关联区块：
        - 客户联系人：内嵌列表与新增入口，跳 LinkEdit/ContactEdit。
        - 客户受托方：Customer_Relation，关联其他客户作为受托方。
        - 拜访/回访：入口到 Follow/FollowEdit。
    - 来源入口：列表新增、订单页“新增客户”快捷入口（AddCustomer）、
      公海领用后编辑、项目/区域（ZoneProject）关联客户等。
    - 返回逻辑：根据 Session["CustomerBack"]、OrderID、ZonePid 等决定返回列表/订单/公海/区域。

2.1.3 客户搜索（Search.aspx）
    - 功能：弹窗内按关键词、业务经理等条件搜索客户，选择后回填到父页面（如订单的“负责客户”）。
    - 参数：select（0=仅选客户，1=选客户后可再选项目等）、userid（按负责人过滤）、pk_Customer（回显）。
    - 数据源：View_Customer_List，与列表类似但为简化列与分页，供订单、项目等 iframe/fancybox 调用。

2.1.4 客户视图（View.aspx）
    - 功能：以思维导图形式展示客户与订单等层级关系，用于可视化查看。
    - 数据：根据客户 ID 加载关联订单等信息，前端渲染为多级节点。

2.1.5 快捷新增客户（AddCustomer.aspx）
    - 功能：仅输入客户名称即可保存，用于订单等场景快速建客户。
    - 说明：页面注明“该入口添加的客户，在客户管理无法搜索”，与主列表数据规则有差异，实现时需注意数据一致性或明确“临时客户”流程。


2.2 联系人管理

2.2.1 联系人列表（Contact.aspx）
    - 功能：全局联系人列表，按客户、类型、关键词筛选，支持导出。
    - 列：类型、客户、联系人、性别、生日、手机、电话、邮箱等。
    - 数据：Address 相关表，fk_Company 指向客户主键。

2.2.2 联系人编辑（LinkEdit.aspx、ContactEdit.aspx）
    - 功能：新增/编辑单条联系人，归属某客户（fk_Company），填写类型、姓名、性别、生日、手机、电话、邮箱等。

2.2.3 联系人导入（List 页）
    - 功能：下载“客户联系人模板” Excel，按模板填写后上传，系统按客户名称匹配客户并写入联系人。
    - 模板列：含客户名称等，与客户列表“客户信息表模板”区分。


2.3 拜访与跟进

2.3.1 拜访记录列表（Follow.aspx）
    - 功能：按客户维度查看拜访记录，显示类型、状态、拜访时间等；支持筛选与分页。
    - 数据：Customer_Follow（fk_Customer、TypeID、StatusID、FollowDate 等）。
    - 客户列表页：展示“最后拜访时间”，超期未拜访有提示（ToolTip）。

2.3.2 拜访编辑（FollowEdit.aspx）
    - 功能：新增或编辑一条拜访记录，关联客户、类型、状态、内容、时间等。

2.3.3 客户拜访-工作日志（FollowWork.aspx）
    - 功能：以“工作日志”形式录入拜访，含简述、详情等，与 Follow 数据关联或互补。


2.4 客户公海

2.4.1 公海列表（Sea.aspx）
    - 功能：展示未归属或已释放到公海的客户，支持“本人领用”筛选；领用前需先联系并填写回复再领用。
    - 操作：领用后客户归属当前用户，可跳转客户编辑（SeaEdit 或 Edit）。

2.4.2 公海编辑（SeaEdit.aspx）
    - 功能：编辑公海客户信息，领用后进入正常客户管理流程；可返回公海列表。

2.4.3 公海片区分配（SeaZone.aspx、SeaZoneEdit.aspx）
    - 功能：按部门/人员分配公海片区，约束谁可查看/领用哪部分公海客户。

2.4.4 公海报表（SeaReport.aspx、SeaReportDetail.aspx）
    - 功能：公海维度统计与明细，供管理层查看公海使用与领用情况。
    - 订单报表等可跳转至 SeaReportDetail。

2.4.5 公海撤销（SeaCancelDetails.aspx）、撤销列表（Repeal.aspx）
    - 功能：公海领用撤销、片区或分配撤销等相关操作与列表。


2.5 转交、分享与审核

2.5.1 转交（List 页弹窗）
    - 功能：勾选一个或多个客户，选择目标用户/部门，提交后生成“客户转交”审核单（Type=1）。
    - 规则：分享过来的客户不可转交（仅可转交本人或本部门拥有的客户）。

2.5.2 全部转交（List 页弹窗）
    - 功能：将当前列表全部客户转交给目标用户，生成一条转交审核单，明细为多客户。

2.5.3 分享（List 页弹窗、ShareDetail.aspx）
    - 功能：将客户分享给他人，可勾选同时分享联系人、拜访、项目、订单、售后等；提交后生成“客户分享”审核单（Type=2）。
    - 审核通过后，对方在“分享的客户”中可见，且不可转交（仅可查看/跟进）。

2.5.4 审核记录（Audit.aspx、AuditEdit.aspx）
    - 功能：审批人处理“客户转交”“客户分享”待审单，通过/拒绝；通过后更新 Customer_List 的 fk_User/fk_Department，并同步更新 Customer_Follow 等关联表；可发通知（CustomerNoticeSend）。


2.6 行业与分类

2.6.1 行业管理（Industry.aspx、IndustryEdit.aspx）
    - 功能：维护行业主数据（Industry_List、Industry_Item 层级），名称、顺序、备注。
    - 用途：客户编辑页“所属行业”多选、列表与报表按行业筛选。

2.6.2 行业搜索（IndustrySearch.aspx）
    - 功能：多选行业条件，用于列表高级搜索或按客户 ID 回显已选行业。


2.7 合作与报表

2.7.1 合作记录（CooperateView.aspx）
    - 功能：从客户列表“合作记录”进入，按客户展示项目、合同等合作信息（项目名称、合同编号等）。

2.7.2 合作客户（Partner.aspx）
    - 功能：合作客户列表，可从公海报表等跳转，支持关键词搜索。

2.7.3 客户报表（Report.aspx）
    - 功能：客户维度统计，如本月新增客户等，按下属、所属行业筛选。


2.8 其他辅助功能

2.8.1 修改记录
    - 功能：跳转通用 UpdateRecord 模块，查看 Customer_List 表字段修改历史（Table=Customer_List）。

2.8.2 客户合并（List 页）
    - 功能：选择两个客户，将其中一个合并到另一个（主客户保留，附属信息并入），操作不可逆；合并后主客户带“合并客户”标识。

2.8.3 客户提醒设置（TimeSetting.aspx、TimeSettingEdit.aspx）
    - 功能：配置客户相关提醒规则（如拜访周期、到期提醒等）。

2.8.4 变更日志（ChangeLog.aspx）
    - 功能：客户相关变更记录列表，便于审计与追溯。

2.8.5 详情列表/时间线（DetailList.aspx）
    - 功能：弹窗内以时间线等形式展示客户详情或动态，供其他页面嵌入。


三、数据模型与表结构
--------------------------------------------------------------------------------

3.1 核心表

3.1.1 Customer_List（客户主表）
    主要字段（参考 MojoCube.Office.Customer.List）：
    - pk_Customer：主键
    - fk_User、fk_Department：负责人、部门
    - FullName、ShortName：客户名称、简称
    - CustomerSource：客户来源（对应 Sys_TypeID，TableName='Customer_List_Source'）
    - StatusID：状态（对应 Sys_StatusID，TableName='Customer_List'）
    - TypeID、CustomerProperty、CustomerLevel、CustomerState 等
    - Industry、Nature、EmployeNum、License、Tags
    - Contact：主联系人姓名
    - 省/市/县、覆盖区域、注册地址等
    - 微信添加情况、备注、大客户标识、隐藏、CombineFlag（合并标识）
    - CreateDate、ModifyDate、CreateUser 等
    说明：实际库表字段以数据库为准，此处为逻辑归纳。

3.1.2 Customer_Follow（拜访记录）
    - 主键、fk_Customer、fk_User、fk_Department
    - TypeID、StatusID（拜访类型、状态，Sys_TypeID/Sys_StatusID，TableName='Customer_Follow'）
    - FollowDate、内容、CreateDate、DeleteFlag 等

3.1.3 Customer_Relation（客户关联）
    - 客户与客户（或受托方）多对多，如 fk_Customer、fk_Link 表示主客户与关联方。

3.1.4 Customer_Industry（客户-行业多对多）
    - fk_Customer、fk_IndustryItem（或等价行业项 ID），关联 Industry_List/Industry_Item。

3.1.5 Customer_Audit_New（审核主表）
    - 审核类型 Type：1=转交，2=分享；状态 Status；申请人、审批人、部门等。

3.1.6 Customer_Audit_New_Detail（审核明细）
    - fk_Audit、fk_Customer、Customer_Name、ApplyUser、RelatedUser、ShareLink/ShareFollow/ShareProject/ShareOrder/ShareService 等分享范围。

3.2 视图（逻辑）

    - View_Customer_List：客户列表视图，含负责人姓名、部门名、来源名称等。
    - View_Customer_Relation：客户与关联客户/受托方视图。
    - View_Customer_Audit_New / View_Customer_Audit_New_Detail：审核单及明细视图。
    - View_Customer_Follow：拜访统计或明细视图。
    - View_Customer_ShareDetail：分享明细视图（类型、状态、共享范围等）。

3.3 配置与字典

    - Sys_TypeID：TableName 如 Customer_List_Source、Customer_List_Indust、Customer_Follow 等，存来源、行业项、拜访类型等。
    - Sys_StatusID：TableName='Customer_List'、'Customer_Follow' 等，存状态。
    - GridViewDisplay：用户自定义列表列，MenuUrl='Customer_List'，Permission 为列名组合（如“客户来源|客户名称|…”）。
    - Area：省市区数据，Parent_Code、Code、Name。
    - Industry_List、Industry_Item：行业层级。

3.4 联系人

    - 联系人存于 Address 相关表（如 MojoCube.Office.Address），fk_Company 指向 pk_Customer；类型、姓名、性别、生日、手机、电话、邮箱等。


四、权限与角色（当前实现）
--------------------------------------------------------------------------------

4.1 功能/按钮级
    - 客户、客户来源、客户名称、客户覆盖区域、客户修改记录、客户模板、客户导入、
      客户全部转交、客户删除 等（HasBtnRoleBool("xxx") 控制按钮显示）。

4.2 列级（列表）
    - GridViewDisplay 表中 Permission 字段保存可见列名，如“客户来源”“客户名称”“所属行业”等，
      列表加载时根据该配置显示/隐藏列。

4.3 数据权限
    - 列表与搜索通过 View_Customer_List 及 Where 条件限制为当前用户负责或本部门、或已分享给当前用户的客户；
      公海与私海分离，公海列表仅展示公海池内客户。


五、与订单、项目、售后的集成
--------------------------------------------------------------------------------

5.1 订单（Order）
    - 订单编辑页“负责客户”：通过 Customer/Search.aspx 弹窗选择客户，选后回填客户 ID 与名称；
      若无可选客户可跳 AddCustomer 快捷新增（该方式新增的客户在客户管理中可能不可搜，需注意）。
    - 订单列表/导出：展示“客户”列，数据来自 Customer_List 或 View 关联的 Customer_Title/FullName。
    - 客户联系人、电话等：订单可带 CustomerName、CustomerPhone1、CustomerPhone2 等，与客户主数据或联系人一致或冗余。

5.2 项目（Project）
    - 项目与客户关联（fk_Customer），项目列表可按客户名称筛选；客户编辑页可跳项目搜索（Notify）。
    - 行业：项目列表行业与 Customer_List_Indust 同源或关联。

5.3 售后（Service）
    - 售后与客户关联，服务列表可查客户；客户反馈可回写订单或客户备注。

5.4 区域/中标项目（ZoneProject）
    - 区域可关联客户（fk_Customer），从区域可跳转客户编辑并做关联。


六、参考实现与优化建议
--------------------------------------------------------------------------------

6.1 建议保留的设计
    - 公海与私海分离、领用与片区分配。
    - 转交/分享走审核流程，审核通过后再改归属。
    - 客户-行业多对多与行业主数据分离。
    - 列表自定义列与列级权限。
    - 客户合并（主客户+并入附属数据）及合并标识。
    - 与订单/项目/售后统一使用“客户搜索”弹窗选客户。

6.2 可优化点
    - AddCustomer 与主列表数据规则统一：要么统一可搜并加来源标识，要么明确“临时客户”及转正流程。
    - 列表类页面（List/Sea/Repeal/ChangeLog）可抽成通用列表组件，减少重复。
    - 权限拆分为：功能权限 + 数据权限 + 敏感列权限，便于扩展。
    - 客户来源/状态等全部走字典配置，导入时按名称或编码匹配，避免硬编码。
    - 修改记录与关键操作（合并、转交、分享）留痕到业务日志或专用表，便于审计。
    - 新系统若为前后端分离，建议列表/搜索/筛选/分页做成统一 API，选客户、选行业做成可复用前端组件。


七、文档修订记录
--------------------------------------------------------------------------------
| 版本 | 日期       | 修订内容           |
| 1.0  | 2025-02-26 | 初稿，基于代码分析 |


================================================================================
                              文档结束
================================================================================
